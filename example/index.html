<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
</head>
<body>
<script type="text/javascript" src="../dist/lemon.front.bundle.js" charset="utf-8"></script>
<div class="log-form">
    <h3>Login Eureka User Pool(Cognito)</h3>
    <input type="text" id="email" title="email" placeholder="email" />
    <input type="password" id="password" title="password" placeholder="password" />
    <button class="btn" onclick="loginToEureka()">Login</button>
    <button class="btn" onclick="register()">Register</button>
    <button class="btn" onclick="logout()">Logout</button>
    <br>
    <button class="btn" onclick="getCredentials()">Get Credentials</button>
    <button class="btn" onclick="getUserAttributes()">Get user attributes</button>
    <button class="btn" onclick="isAuthenticated()">Check isAuthenticated</button>
    <button class="btn" onclick="refreshSession()">Get refreshSession</button>
</div>
<div>
    <h3>Kakao Login</h3>
    <button class="btn" onclick="loginWithKakao()">Kakao Login</button>
    <h4 id="kakao-result"></h4>
</div>
<div>
    <h3>HTTP Request</h3>
    <button class="btn" onclick="getAllInquiries()">Request Eureka(authorizer)</button>
    <button class="btn" onclick="getOauthUser()">Request User(authorizer)</button>
    <button class="btn" onclick="requestTestWithoutCredentials()">Request Hello</button>
</div>
<div>
    <h3>Result</h3>
    <h4 id="result"></h4>
</div>

<script type="text/javascript">
    var options = {
        host: 'api.eureka.deals',
        region: 'ap-northeast-2',
        identityPoolId: 'ap-northeast-2:f523f459-860a-456c-aafe-cd26999c4626', // Eureka Identity Pool
        userPoolId: 'ap-northeast-2_FD7tDusCs', // eureka-user-pool
        clientId: '297afu2njla9kev9f6rt4h4156', // eureka-front-web
    };
    var lemonFrontCore = new Lemon.CoreService(options);
    var userPoolService = lemonFrontCore.getUserPoolInstance();

    function createUserInfoObject(attr) {
        var result = {};
        attr.map(function(item) {
            result[item.getName()] = item.getValue();
            return item;
        });
        return result;
    }

    function register() {
        var email = document.getElementById('email').value;
        var password = document.getElementById('password').value;
        var nickname = 'tester';

        userPoolService.register({ email: email, password: password, nickname: nickname })
            .then(function(res) {
                console.log(res);
                document.getElementById('result').innerText = JSON.stringify(res);
            })
            .catch(function(err) {
                setErrorMessage(err);
            });
    }

    function loginToEureka() {
        var email = document.getElementById('email').value;
        var password = document.getElementById('password').value;
        userPoolService.authenticate(email, password)
            .then(function(res) {
                console.log(res);
                document.getElementById('result').innerText = JSON.stringify(res);
                return lemonFrontCore.getIdentityCredentials(); // 로그인 후 Credentials 가져와야함
            })
            .catch(function(err) {
                setErrorMessage(err);
            });
    }

    function logout() {
        lemonFrontCore.logout();
        location.replace('http://localhost:8888');
    }

    function getUserAttributes() {
        userPoolService.getUserAttributes()
            .then(function(attr) {
                console.log(attr);
                var obj = createUserInfoObject(attr);
                document.getElementById('result').innerText = JSON.stringify(obj);
            })
            .catch(function(err) {
                setErrorMessage(err);
            });
    }

    function getCredentials() {
        lemonFrontCore.getIdentityCredentials()
            .then(function(res) {
                console.log(res);
                document.getElementById('result').innerText = 'result: ' + res;
            })
            .catch(function(err) {
                setErrorMessage(err);
            });
    }

    function isAuthenticated() {
        lemonFrontCore.isAuthenticated()
            .then(function(res) {
                console.log(res);
                document.getElementById('result').innerText = res;
            })
            .catch(function(err) {
                setErrorMessage(err);
            });
    }

    function refreshSession() {
        userPoolService.getRefreshToken()
            .then(function(token) {
                console.log('token', token);
                return userPoolService.refreshSession(token);
            })
            .then(function(session) {
                console.log('session', session);
                document.getElementById('result').innerText = JSON.stringify(session);
            })
            .catch(function(err) {
                setErrorMessage(err);
            });
    }

    function getAllInquiries() {
        var ENDPOINT = 'https://api.eureka.deals';
        lemonFrontCore.requestWithSign('GET', ENDPOINT, '/hooks/main-items')
            .then(function(items) {
                console.log('items', items);
                document.getElementById('result').innerText = JSON.stringify(items);
            })
            .catch(function(err) {
                setErrorMessage(err);
            });
    }

    function getOauthUser() {
        var ENDPOINT = 'https://dev.oauth.lemoncloud.io/user/0';
        simpleGetRequest(ENDPOINT);
    }

    function requestTestWithoutCredentials() {
        var ENDPOINT = 'https://dev.oauth.lemoncloud.io/hello/0';
        simpleGetRequest(ENDPOINT);
    }

    function simpleGetRequest(endpoint) {
        lemonFrontCore.requestWithSign('GET', endpoint, '/')
            .then(function(mock) {
                console.log('mock', mock);
                document.getElementById('result').innerText = JSON.stringify(mock);
            })
            .catch(function(err) {
                setErrorMessage(err);
            });
    }

    function setErrorMessage(err) {
        console.error(err);
        document.getElementById('result').innerText = 'ERROR: ' + err.message;
    }

    function loginWithKakao() {
        var OAUTH_ENPOINT = 'https://dev.oauth.lemoncloud.io';
        var CLIENT_ID_KAKAO = '31863a03d75db2967d9138ea8c60de05';
        var REDIRECT_URI = 'http://localhost:8888';
        // lemon oauth api를 통해 redirect 되서 redirectUrl로 돌아옴
        window.location.replace(`${OAUTH_ENPOINT}/oauth/kakao/authorize?client=${CLIENT_ID_KAKAO}&redirect=${REDIRECT_URI}`);
    }

    function checkHasKakaoCode() {
        var urlParams = new URLSearchParams(window.location.search);
        var codeData = urlParams.get('code');
        if (!codeData) {
            return;
        }

        console.log(codeData);
        var ENDPOINT = 'https://dev.oauth.lemoncloud.io/oauth/kakao/token';
        lemonFrontCore.requestWithSign('POST', ENDPOINT, '/', {}, { code: codeData })
            .then(function(data) {
                console.log('credential', data); // result: { credential: { AccessKeyId, SecretKey, SessionToken }, identityId, identityPoolId, identityToken }
                var credential = data.credential;
                var sessionToken = credential.SessionToken ? credential.SessionToken : ''; // sessionToken: optional
                return lemonFrontCore.buildCredentialsByToken(credential.AccessKeyId, credential.SecretKey, sessionToken);
            })
            .then(function(data) {
                console.log('access Key', data);
                document.getElementById('kakao-result').innerText = JSON.stringify(data);
            })
            .catch(function(err) {
                setErrorMessage(err);
            });
    }

    checkHasKakaoCode();
</script>
</body>
</html>
