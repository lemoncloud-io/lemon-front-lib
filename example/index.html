<html>
<head>
    <meta charset="utf-8">
</head>
<body>
<script type="text/javascript" src="../dist/lemon.front.lib.js" charset="utf-8"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/rxjs/6.5.3/rxjs.umd.min.js" charset="utf-8"></script>
<div class="log-form">
    <h2>Login to your account</h2>
    <input type="text" id="username" title="username" placeholder="username" />
    <input type="password" id="password" title="password" placeholder="password" />
    <button class="btn" onclick="loginToEureka()">Login</button>
</div><!--end log form -->
<div>
    request
    <button class="btn" onclick="requestAlarms()">request Alarms</button>
    <h2 id="result"></h2>
</div>

<script type="text/javascript">
    var options = {
        host: 'api.eureka.deals',
        region: 'ap-northeast-2',
        identityPoolId: 'ap-northeast-2:f523f459-860a-456c-aafe-cd26999c4626', // Eureka Identity Pool
        userPoolId: 'ap-northeast-2_FD7tDusCs', // eureka-user-pool
        clientId: '297afu2njla9kev9f6rt4h4156', // eureka-front-web
    };
    var lemonFrontCore = new Lemon.CoreService(options);

    function getUserInfoFromCognito(attr) {
        var result = {};
        attr.map(item => {
            result[item.getName()] = item.getValue();
            return item;
        });
        return result;
    }

    function loginToEureka() {
        var username = document.getElementById('username').value;
        var password = document.getElementById('password').value;

        lemonFrontCore.getCognitoInstance().authenticate(username, password).subscribe((res) => {
            console.log(res);
        });
    }

    function requestAlarms() {
        const isAuthenticated$ = lemonFrontCore.getCognitoInstance().isAuthenticated();
        const request$ = isAuthenticated$.pipe(
            filter(isAuth => isAuth),
            switchMap(() => lemonFrontCore.getCognitoInstance().getUserAttributes()),
            switchMap(attr => {
                var cognitoUser = getUserInfoFromCognito(attr);
                var owner = cognitoUser.sub || cognitoUser.email;
                return lemonFrontCore.doSignedRequest$('GET', 'https://api.eureka.deals', '/alarms/' + owner);
            }),
        );
        request$.subscribe((res) => {
            document.getElementById('result').innerText = res;
        })
    }


</script>
</body>
</html>
