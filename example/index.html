<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
</head>
<body>
<script type="text/javascript" src="../dist/lemon.front.bundle.js" charset="utf-8"></script>
<div>
    <h3>Kakao Login</h3>
    <button class="btn" onclick="loginWithKakao()">Kakao Login</button>
    <button class="btn" onclick="isAuthenticated()">check isLogin</button>
    <button class="btn" onclick="logout()">logout</button>
    <button class="btn" onclick="getCredentials()">get credentials</button>
    <br>
    <span>Login status: <span id="kakao-result">false</spani></span>
</div>
<div>
    <h3>HTTP Request</h3>
    <button class="btn" onclick="getAllInquiries()">Request Eureka(authorizer)</button>
    <button class="btn" onclick="getUserProfile()">Request Profile(authorizer)</button>
    <button class="btn" onclick="requestTestWithoutCredentials()">Request Hello</button>
</div>
<div>
    <h3>Result</h3>
    <h4 id="result"></h4>
</div>

<script type="text/javascript">
    var authService = new Lemon.AuthService();

    function logout() {
        authService.logout();
        location.replace('http://localhost:8888');
    }

    function getCredentials() {
        authService.getCredentials()
            .then(function(res) {
                console.log(res);
                document.getElementById('result').innerText = 'result: ' + JSON.stringify(res);
            })
            .catch(function(err) {
                setErrorMessage(err);
            });
    }

    function isAuthenticated() {
        authService.isAuthenticated()
            .then(function(res) {
                console.log(res);
                document.getElementById('result').innerText = res;
            })
            .catch(function(err) {
                setErrorMessage(err);
            });
    }

    function getUserProfile() {
        var ENDPOINT = 'https://dev.oauth.lemoncloud.io/user/0/profile';
        simpleGetRequest(ENDPOINT);
    }

    function getAllInquiries() {
        var ENDPOINT = 'https://api.eureka.deals/hooks/main-items';
        simpleGetRequest(ENDPOINT);
    }

    function requestTestWithoutCredentials() {
        var ENDPOINT = 'https://dev.oauth.lemoncloud.io/hello/0';
        simpleGetRequest(ENDPOINT);
    }

    function simpleGetRequest(endpoint) {
        authService.requestWithSign('GET', endpoint, '/')
            .then(function(mock) {
                console.log('mock', mock);
                document.getElementById('result').innerText = JSON.stringify(mock);
            })
            .catch(function(err) {
                setErrorMessage(err);
            });
    }

    function setErrorMessage(err) {
        console.error(err);
        document.getElementById('result').innerText = 'ERROR: ' + err.message;
    }

    function loginWithKakao() {
        var OAUTH_ENPOINT = 'https://dev.oauth.lemoncloud.io';
        var CLIENT_ID_KAKAO = '31863a03d75db2967d9138ea8c60de05';
        var REDIRECT_URI = 'http://localhost:8888';
        // lemon oauth api를 통해 redirect 되서 redirectUrl로 돌아옴
        window.location.replace(`${OAUTH_ENPOINT}/oauth/kakao/authorize?client=${CLIENT_ID_KAKAO}&redirect=${REDIRECT_URI}`);
    }

    function checkHasKakaoCode() {
        var urlParams = new URLSearchParams(window.location.search);
        var codeData = urlParams.get('code');
        if (!codeData) {
            return;
        }

        console.log(codeData);
        var ENDPOINT = 'https://dev.oauth.lemoncloud.io/oauth/kakao/token';
        authService.requestWithSign('POST', ENDPOINT, '/', {}, { code: codeData })
            .then(function(data) {
                console.log('token', data); // result: { credential: { AccessKeyId, SecretKey, SessionToken }, identityId, identityPoolId, identityToken }
                return authService.buildCredentialsByToken(data);
            })
            .then(function(data) {
                console.log('access Key', data);
                document.getElementById('kakao-result').innerText = 'true';
            })
            .catch(function(err) {
                setErrorMessage(err);
            });
    }

    checkHasKakaoCode();
</script>
</body>
</html>
